/*
 * BlackBox - jQuery Plugin
 * version: 0.9 (8/03/2013)
 * @requires jQuery v1.4 or later
 *
 *
 * Copyright 2013 Vincent Ting
 * Website http://vincenting.com/
 * License : MIT License / GPL License
 *
 */

(function(){var a=this,b=0,c=[],d={},e=$(window),f=function(){this.init.apply(this,arguments)};f.fn=f.prototype,f.fn.init=function(a){var b={clickOverlayEffect:"shake",overlayColor:"#000",overlayOpacity:.6,forceLoad:!0,allowPromptBlank:!1,allowBoxScrolling:!0,displayClose:!1,enableKeyPress:!0};if("[object Object]"==Object.prototype.toString.call(a)){var c={};jQuery.each(b,function(b,d){c[b]=a[b]||d}),this.config=c}else this.config=b;this.config.enableKeyPress&&this._setKeyShort.call(this)},f.fn.load=function(a,b,c){if(0!==arguments.length){b=b||$.noop,c||("[object Array]"==Object.prototype.toString.call(d[a])&&d[a].push(b),d[a]=[b]);for(var f in d)if(f!==a)return;if(1===arguments.length&&Array.prototype.push.call(arguments,b),this._setOverlay.call(this,"load",arguments,c)||c){$("#BlackBox").append('<div id="BlackBoxLoad">载入中</div>');var g=$("#BlackBoxLoad").fadeTo(0,0).fadeTo(400,1),h=function(){g.css({left:(e.width()-g.width())/2,top:(e.height()-g.height())/2})};h.call(this),e.resize(h)}}},f.fn.ready=function(a){if(0!==arguments.length){var b=d[a];if(b)for(var c=0;b.length>c;c++){var e=b[c];e.call(this)}delete d[a];for(var f in d)if(d.hasOwnProperty(f))return;$("#BlackBoxLoad").fadeTo(400,0),this._clearOverlay.call(this)}},f.fn.loadClear=function(a){a=a||$.noop;for(var b in d)d.hasOwnProperty(b)&&delete d[b];$("#BlackBoxLoad").fadeTo(400,0),this._clearOverlay.call(this,a)},f.fn.alert=function(){if(0!==arguments.length){var e=this._getArgs.apply(this,arguments);if(this._setOverlay.call(this,"alert",e,e[3])||e[3]){var f=$("#BlackBox");f.append('<div class = "system Inner" id="alert'+this._getNowID()+'"><p>'+e[0]+"</p></div>"),this._boxWrap($("#alert"+this._getNowID()),e[2]),this._setOverlayAttr.call(this),this.config.displayClose&&this._setClose.call(this,e[1]),this._setButton.call(this,e[1],null,e[2])}}},f.fn.confirm=function(){if(0!==arguments.length){var e=this._getArgs.apply(this,arguments);if(this._setOverlay.call(this,"confirm",e,e[3])||e[3]){var f=$("#BlackBox");f.append('<div class = "system Inner" id="confirm'+this._getNowID()+'"><p>'+e[0]+"</p></div>"),this._boxWrap($("#confirm"+this._getNowID()),e[2]),this._setOverlayAttr.call(this);var g=function(){return e[1].call(this,!0)},h=function(){return e[1].call(this,!1)};this.config.displayClose&&this._setClose.call(this,h),this._setButton.call(this,g,h,e[2])}}},f.fn.prompt=function(){if(0!==arguments.length){var e=this._getArgs.apply(this,arguments);if(this._setOverlay.call(this,"prompt",arguments,e[3])||e[3]){var f=e[2].verify||function(){return!0},g=$("#BlackBox");g.append('<div class = "system Inner" id="prompt'+this._getNowID()+'"><p>'+e[0]+'</p><input id="boxInput"></div>'),this._boxWrap($("#prompt"+this._getNowID()),e[2]),this._setOverlayAttr.call(this);var h=$("#boxInput").focus(),i=function(){return e[1].call(this,h.val())},j=function(){return e[1].call(this,null)},k=this;h.blur(function(){$(this).val($.trim($(this).val()))}),this.config.displayClose&&this._setClose.call(this,j),e[2].verify=function(){return(k.config.allowPromptBlank||h.val())&&f.call(this,h.val())?!0:(h.addClass("boxError").focus(),!1)},this._setButton.call(this,i,j,e[2])}}},f.fn.popup=function(a,b){if(0===arguments.length)return e;if(!this._setOverlay.call(this,"popup",arguments,b)&&!b)return e;var c=$("#BlackBox");return c.append('<div class="normal" id="popup'+this._getNowID()+'">'+a+"</div>"),this._boxWrap($("#popup"+this._getNowID())),this._setOverlayAttr.call(this),c},f.fn.boxClose=function(a){var b=$("#"+this._getNowID()),c=this;b[0]&&b.fadeOut(400,function(){$(this).remove(),c._clearOverlay.call(c,a)})},f.fn.boxShake=function(){var a=$("#"+this._getNowID());if(a[0])for(var b=a.offset().left,c=1;4>=c;c++)a.animate({left:b-(12-3*c)},50),a.animate({left:b+2*(12-3*c)},50)},f.fn._getArgs=function(a,b,c){return b=b||$.noop,$.isFunction(b)||(c=b,b=$.noop),c=c||{},1===arguments.length&&Array.prototype.push.call(arguments,b,c),2===arguments.length&&Array.prototype.push.call(arguments,c),arguments},f.fn._boxWrap=function(a,b){a.wrap('<div class="BlackBoxContent" id="'+this._getNowID()+'"></div>');var c=$("#"+this._getNowID()).fadeTo(0,0).fadeTo(400,1),d=c.width(),f=c.height(),g=function(){c.css({left:(e.width()-d)/2+"px",top:(e.height()-f-80)/2+"px"})};b.title&&c.prepend('<p class="title">'+b.title+"</div>"),e.resize(g),g.call(this)},f.fn._setKeyShort=function(){var a=this;$(document).bind("keydown.fb",function(b){var c=$(".BlackBoxContent");if(13==b.keyCode)b.preventDefault(),c.find(".submit").click();else if(27==b.keyCode){b.preventDefault();var d=c.find(".close")[0]||c.find(".cancel")[0]||c.find(".submit")[0];d?$(d).click():a.boxClose.call(a)}})},f.fn._setOverlay=function(a,d,f){if(b+=1,f||c.push({id:b,type:a,args:d}),1!==c.length)return!1;$("body").append('<div id="BlackBox"><div id="BBOverlay"></div></div>');var g=$("#BBOverlay"),h=this.config;f||g.css({background_color:h.overlayColor}).fadeTo(0,0).fadeTo(400,h.overlayOpacity);var i=function(){g.width(e.width()+"px").height(e.height()+"px")};return i.call(this),e.resize(i),!0},f.fn._clearOverlay=function(a,b){b?c.length=0:c.shift();var d=this;$("#BBOverlay").unbind("click"),0==c.length?$("#BlackBox").fadeOut(400,function(){$(this).remove(),a&&a.call(d)}):(a&&a.call(this),Array.prototype.push.call(c[0].args,!0),this[c[0].type].apply(this,c[0].args))},f.fn._setOverlayAttr=function(){var a=this.config.clickOverlayEffect,b=$("#"+this._getNowID()),c=$("#BBOverlay"),d=this;return"close"===a?(c.click(function(){var a=b.find(".close")[0]||b.find(".cancel")[0]||b.find(".submit")[0];a?$(a).click():d.boxClose.call(d)}),void 0):(c.click(function(){var a=b.find("input");1===a.length&&a.focus(),d.boxShake.call(d)}),void 0)},f.fn._setButton=function(a,b,c){if(0!==arguments.length){var d=$("#"+this._getNowID()),e=this;d.find(".Inner").append('<div id="BlackBoxAction"></div>');var f=$("#BlackBoxAction");if(b&&(f.append('<button class="cancel">取消</button>'),f.find(".cancel").click(function(){e.boxClose.call(e,b)})),a){var g=c.value||"确定";f.append('<button class="submit">'+g+"</button>"),f.find(".submit").click(function(){!c.verify||c.verify.call(e)?e.boxClose.call(e,a):e.boxShake.call(e)})}}},f.fn._setClose=function(a){var b=$("#"+this._getNowID()),c=this;b.append('<div class="close">Close</div>'),b.find(".close").click(function(){c.boxClose.call(c,a)})},f.fn._getNowID=function(){var a=c[0].id;return"_box_"+a},a.BlackBox=f,a.__=new f}).call(window);